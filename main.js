const translations = {
    fa: { 'nav.logo': 'MH', 'nav.home': 'خانه', 'nav.about': 'درباره من', 'nav.projects': 'پروژه‌ها', 'nav.experience': 'تجربیات', 'nav.contact': 'تماس', 'hero.name': 'محمد حسن هاشمی', 'hero.title': 'مهندس ارشد فول‌استک', 'hero.description': 'متخصص در React، Vue، Node.js، NestJS و NuxtJS', 'hero.contact': 'تماس با من', 'hero.linkedin': 'لینکدین', 'about.title': 'درباره من', 'about.description': 'من یک مهندس نرم‌افزار با بیش از ۵ سال تجربه در توسعه وب هستم. تخصص من در ساخت اپلیکیشن‌های مدرن و قابل اعتماد با استفاده از جدیدترین تکنولوژی‌ها است.', 'about.skills': 'مهارت‌های من', 'projects.title': 'پروژه‌های من', 'projects.demo': 'نمایش', 'projects.code': 'کد', 'projects.project1.title': 'پلتفرم تجارت الکترونیک', 'projects.project1.description': 'یک پلتفرم کامل تجارت الکترونیک با React و Node.js', 'projects.project2.title': 'داشبورد مدیریت', 'projects.project2.description': 'داشبورد مدیریت پیشرفته با Vue.js و NuxtJS', 'projects.project3.title': 'API مایکروسرویس', 'projects.project3.description': 'معماری مایکروسرویس با NestJS و Docker', 'experience.title': 'تجربیات کاری', 'experience.job1.date': '۲۰۲۲ - اکنون', 'experience.job1.title': 'مهندس ارشد فول‌استک', 'experience.job1.company': 'شرکت تکنولوژی پیشرو', 'experience.job1.description': 'رهبری تیم توسعه و طراحی معماری سیستم‌های پیچیده', 'experience.job2.date': '۲۰۲۰ - ۲۰۲۲', 'experience.job2.title': 'توسعه‌دهنده فول‌استک', 'experience.job2.company': 'استارتاپ نوآور', 'experience.job2.description': 'توسعه اپلیکیشن‌های وب مدرن با React و Node.js', 'experience.job3.date': '۲۰۱۹ - ۲۰۲۰', 'experience.job3.title': 'توسعه‌دهنده فرانت‌اند', 'experience.job3.company': 'آژانس دیجیتال', 'experience.job3.description': 'ساخت رابط کاربری واکنش‌گرا و تجربه کاربری بهینه', 'contact.title': 'تماس با من', 'contact.email.title': 'ایمیل', 'contact.phone.title': 'تلفن', 'contact.linkedin.title': 'لینکدین', 'contact.form.name': 'نام شما', 'contact.form.email': 'ایمیل شما', 'contact.form.message': 'پیام شما', 'contact.form.send': 'ارسال پیام', 'footer.copyright': '© ۲۰۲۴ محمد حسن هاشمی. تمام حقوق محفوظ است.', 'lang.select': 'انتخاب زبان', 'lang.close': 'بستن' },
    en: { 'nav.logo': 'MH', 'nav.home': 'Home', 'nav.about': 'About', 'nav.projects': 'Projects', 'nav.experience': 'Experience', 'nav.contact': 'Contact', 'hero.name': 'Mohammad Hassan Hashemi', 'hero.title': 'Senior Full-Stack Engineer', 'hero.description': 'Specialized in React, Vue, Node.js, NestJS and NuxtJS', 'hero.contact': 'Contact Me', 'hero.linkedin': 'LinkedIn', 'about.title': 'About Me', 'about.description': 'I am a software engineer with over 5 years of experience in web development. My expertise lies in building modern and reliable applications using the latest technologies.', 'about.skills': 'My Skills', 'projects.title': 'My Projects', 'projects.demo': 'Demo', 'projects.code': 'Code', 'projects.project1.title': 'E-commerce Platform', 'projects.project1.description': 'A complete e-commerce platform built with React and Node.js', 'projects.project2.title': 'Management Dashboard', 'projects.project2.description': 'Advanced management dashboard with Vue.js and NuxtJS', 'projects.project3.title': 'Microservice API', 'projects.project3.description': 'Microservice architecture with NestJS and Docker', 'experience.title': 'Work Experience', 'experience.job1.date': '2022 - Present', 'experience.job1.title': 'Senior Full-Stack Engineer', 'experience.job1.company': 'Leading Technology Company', 'experience.job1.description': 'Leading development team and designing complex system architectures', 'experience.job2.date': '2020 - 2022', 'experience.job2.title': 'Full-Stack Developer', 'experience.job2.company': 'Innovative Startup', 'experience.job2.description': 'Developing modern web applications with React and Node.js', 'experience.job3.date': '2019 - 2020', 'experience.job3.title': 'Frontend Developer', 'experience.job3.company': 'Digital Agency', 'experience.job3.description': 'Building responsive user interfaces and optimal user experiences', 'contact.title': 'Contact Me', 'contact.email.title': 'Email', 'contact.phone.title': 'Phone', 'contact.linkedin.title': 'LinkedIn', 'contact.form.name': 'Your Name', 'contact.form.email': 'Your Email', 'contact.form.message': 'Your Message', 'contact.form.send': 'Send Message', 'footer.copyright': '© 2024 Mohammad Hassan Hashemi. All rights reserved.', 'lang.select': 'Select Language', 'lang.close': 'Close' },
    ar: { 'nav.logo': 'MH', 'nav.home': 'الرئيسية', 'nav.about': 'نبذة عني', 'nav.projects': 'المشاريع', 'nav.experience': 'الخبرات', 'nav.contact': 'اتصل بي', 'hero.name': 'محمد حسن هاشمي', 'hero.title': 'مهندس برمجيات أول', 'hero.description': 'متخصص في React و Vue و Node.js و NestJS و NuxtJS', 'hero.contact': 'اتصل بي', 'hero.linkedin': 'لينكد إن', 'about.title': 'نبذة عني', 'about.description': 'أنا مهندس برمجيات لدي أكثر من 5 سنوات من الخبرة في تطوير الويب. خبرتي تكمن في بناء تطبيقات حديثة وموثوقة باستخدام أحدث التقنيات.', 'about.skills': 'مهاراتي', 'projects.title': 'مشاريعي', 'projects.demo': 'عرض', 'projects.code': 'الكود', 'projects.project1.title': 'منصة التجارة الإلكترونية', 'projects.project1.description': 'منصة تجارة إلكترونية كاملة مبنية بـ React و Node.js', 'projects.project2.title': 'لوحة تحكم الإدارة', 'projects.project2.description': 'لوحة تحكم إدارة متقدمة مع Vue.js و NuxtJS', 'projects.project3.title': 'واجهة برمجة التطبيقات المصغرة', 'projects.project3.description': 'معمارية الخدمات المصغرة مع NestJS و Docker', 'experience.title': 'الخبرة العملية', 'experience.job1.date': '2022 - الحاضر', 'experience.job1.title': 'مهندس برمجيات أول', 'experience.job1.company': 'شركة التكنولوجيا الرائدة', 'experience.job1.description': 'قيادة فريق التطوير وتصميم معماريات الأنظمة المعقدة', 'experience.job2.date': '2020 - 2022', 'experience.job2.title': 'مطور برمجيات شامل', 'experience.job2.company': 'شركة ناشئة مبتكرة', 'experience.job2.description': 'تطوير تطبيقات ويب حديثة مع React و Node.js', 'experience.job3.date': '2019 - 2020', 'experience.job3.title': 'مطور واجهة أمامية', 'experience.job3.company': 'وكالة رقمية', 'experience.job3.description': 'بناء واجهات مستخدم متجاوبة وتجارب مستخدم مثلى', 'contact.title': 'اتصل بي', 'contact.email.title': 'البريد الإلكتروني', 'contact.phone.title': 'الهاتف', 'contact.linkedin.title': 'لينكد إن', 'contact.form.name': 'اسمك', 'contact.form.email': 'بريدك الإلكتروني', 'contact.form.message': 'رسالتك', 'contact.form.send': 'إرسال الرسالة', 'footer.copyright': '© 2024 محمد حسن هاشمي. جميع الحقوق محفوظة.', 'lang.select': 'اختر اللغة', 'lang.close': 'إغلاق' }
};

class PortfolioApp {
    constructor() {
        this.state = {
            currentLang: 'fa',
            currentTheme: 'dark',
            isTyping: false,
            prefersReducedMotion: window.matchMedia('(prefers-reduced-motion: reduce)').matches
        };

        this.init();
    }

    init() {
        this._setupPreloader();
        this._setupTheme();
        this._setupLanguage();
        if (!this.state.prefersReducedMotion) {
            this._setupCustomCursor();
            this._setupProjectCardTilt();
            this._setupParticles();
        }
        this._setupNavigation();
        this._setupScrollAnimations();
        this._setupContactForm();
        this._setupFloatingLabels();
    }

    _setupPreloader() {
        const preloader = document.querySelector('.preloader');
        window.addEventListener('load', () => {
            setTimeout(() => {
                preloader.classList.add('hidden');
                document.body.style.overflow = 'auto';
                this._startTypingAnimation();
            }, 1000);
             setTimeout(() => {
                preloader.style.display = 'none';
            }, 1500);
        });
    }

    _setupTheme() {
        this.state.currentTheme = localStorage.getItem('theme') || 'dark';
        document.body.setAttribute('data-theme', this.state.currentTheme);

        const themeToggles = [document.getElementById('themeToggleDesktop'), document.getElementById('themeToggleMobile')];
        
        themeToggles.forEach(toggle => {
            if(toggle) {
                toggle.addEventListener('click', () => {
                    this.state.currentTheme = this.state.currentTheme === 'dark' ? 'light' : 'dark';
                    document.body.setAttribute('data-theme', this.state.currentTheme);
                    localStorage.setItem('theme', this.state.currentTheme);
                    this._updateThemeIcons();
                });
            }
        });
        this._updateThemeIcons();
    }
    
    _updateThemeIcons() {
        const themeIcons = document.querySelectorAll('.theme-icon, #themeToggleMobile');
        const icon = this.state.currentTheme === 'dark' ? '☀️' : '🌙';
        themeIcons.forEach(el => el.textContent = icon);
    }
    
    _setupLanguage() {
        // Desktop
        const langMenuToggle = document.querySelector('.lang-menu-toggle');
        const langMenu = document.querySelector('.lang-menu');
        langMenuToggle.addEventListener('click', () => langMenu.classList.toggle('active'));
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.language-switcher')) {
                langMenu.classList.remove('active');
            }
        });
        document.querySelectorAll('.language-switcher .lang-btn').forEach(btn => {
            btn.addEventListener('click', () => this._changeLanguage(btn.dataset.lang));
        });

        // Mobile
        const langToggleMobile = document.getElementById('langToggleMobile');
        const langModalOverlay = document.querySelector('.lang-modal-overlay');
        const langModalClose = document.querySelector('.lang-modal-close');

        langToggleMobile.addEventListener('click', () => langModalOverlay.classList.add('active'));
        langModalClose.addEventListener('click', () => langModalOverlay.classList.remove('active'));
        langModalOverlay.addEventListener('click', (e) => {
            if (e.target === langModalOverlay) langModalOverlay.classList.remove('active');
        });
        document.querySelectorAll('.lang-modal-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                this._changeLanguage(btn.dataset.lang);
                langModalOverlay.classList.remove('active');
            });
        });

        this._changeLanguage(this.state.currentLang);
    }

    _changeLanguage(lang) {
        if (!translations[lang]) return;
        this.state.currentLang = lang;
        const html = document.documentElement;
        html.setAttribute('lang', lang);
        html.setAttribute('dir', ['ar', 'fa'].includes(lang) ? 'rtl' : 'ltr');

        document.querySelectorAll('[data-key]').forEach(element => {
            const key = element.dataset.key;
            const translation = translations[lang][key];
            if (translation !== undefined) {
                if (element.classList.contains('typing-text')) {
                    // Handled by _startTypingAnimation
                } else if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                    element.placeholder = translation;
                } else {
                    element.innerHTML = translation;
                }
            }
        });
        
        this._updateActiveLangButtons(lang);
        this._startTypingAnimation();
    }
    
    _updateActiveLangButtons(lang) {
        document.querySelectorAll('.lang-btn, .lang-modal-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.lang === lang);
        });
    }

    _startTypingAnimation() {
        const el = document.querySelector('.typing-text');
        if (!el || this.state.isTyping) return;

        const text = translations[this.state.currentLang]['hero.name'];
        el.textContent = '';
        el.style.width = '0';
        
        this.state.isTyping = true;
        let i = 0;
        
        const type = () => {
            if (i < text.length) {
                el.textContent += text.charAt(i);
                i++;
                setTimeout(type, 100);
            } else {
                el.style.width = ''; // Let it be auto
                this.state.isTyping = false;
            }
        };
        setTimeout(type, 500);
    }

    _setupCustomCursor() {
        const cursor = document.querySelector('.cursor');
        const follower = document.querySelector('.cursor-follower');
        let mouseX = 0, mouseY = 0, followerX = 0, followerY = 0;

        document.addEventListener('mousemove', e => {
            mouseX = e.clientX;
            mouseY = e.clientY;
        });

        const animateFollower = () => {
            followerX += (mouseX - followerX) * 0.1;
            followerY += (mouseY - followerY) * 0.1;
            cursor.style.transform = `translate3d(${mouseX}px, ${mouseY}px, 0)`;
            follower.style.transform = `translate3d(${followerX}px, ${followerY}px, 0)`;
            requestAnimationFrame(animateFollower);
        };
        animateFollower();
        
        document.querySelectorAll('a, button, .project-card').forEach(el => {
            el.addEventListener('mouseenter', () => follower.classList.add('active'));
            el.addEventListener('mouseleave', () => follower.classList.remove('active'));
        });
    }

    _setupNavigation() {
        const hamburger = document.querySelector('.hamburger');
        const navMenu = document.querySelector('.nav-menu');
        const navLinks = document.querySelectorAll('.nav-link, .mobile-nav-btn[href]');
        const navbar = document.querySelector('.navbar');

        hamburger.addEventListener('click', () => {
            hamburger.classList.toggle('active');
            navMenu.classList.toggle('active');
            document.body.classList.toggle('no-scroll');
        });

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = link.getAttribute('href');
                document.querySelector(targetId).scrollIntoView({ behavior: 'smooth' });
                hamburger.classList.remove('active');
                navMenu.classList.remove('active');
                document.body.classList.remove('no-scroll');
            });
        });
        
        // Active link highlighting
        const sections = document.querySelectorAll('section[id]');
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if(entry.isIntersecting) {
                    document.querySelectorAll('.nav-link').forEach(link => {
                        link.classList.toggle('active', link.getAttribute('href') === `#${entry.target.id}`);
                    });
                }
            });
        }, { rootMargin: '-50% 0px -50% 0px'});
        sections.forEach(sec => observer.observe(sec));
        
        // Navbar scroll effect
        window.addEventListener('scroll', () => {
            navbar.classList.toggle('scrolled', window.scrollY > 50);
        });
    }
    
    _setupScrollAnimations() {
        const elements = document.querySelectorAll('.section-header, .about-content > *, .project-card, .timeline-item, .contact-info > *, .contact-form');
        const observer = new IntersectionObserver(entries => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('in-view');
                    observer.unobserve(entry.target);
                }
            });
        }, { threshold: 0.1 });
        elements.forEach(el => observer.observe(el));
    }
    
    _setupProjectCardTilt() {
        const cards = document.querySelectorAll('.project-card');
        cards.forEach(card => {
            card.addEventListener('mousemove', (e) => {
                const rect = card.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                const { width, height } = rect;
                const rotateX = (y / height - 0.5) * -20;
                const rotateY = (x / width - 0.5) * 20;
                card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
            });
            card.addEventListener('mouseleave', () => {
                card.style.transform = 'perspective(1000px) rotateX(0) rotateY(0)';
            });
        });
    }

    _setupContactForm() {
        const form = document.getElementById('contactForm');
        const statusEl = form.querySelector('.form-status');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = form.querySelector('.submit-btn');
            submitBtn.classList.add('loading');
            
            // Simulate API call
            await new Promise(resolve => setTimeout(resolve, 1500));

            submitBtn.classList.remove('loading');
            form.reset();
            document.querySelectorAll('.form-group label.focused').forEach(l => l.classList.remove('focused'));

            statusEl.textContent = this.state.currentLang === 'fa' ? 'پیام شما با موفقیت ارسال شد!' : 'Your message has been sent successfully!';
            statusEl.classList.add('success');
            
            setTimeout(() => {
                statusEl.textContent = '';
                statusEl.classList.remove('success');
            }, 5000);
        });
    }

    _setupFloatingLabels() {
        document.querySelectorAll('.form-group').forEach(group => {
            const input = group.querySelector('input, textarea');
            const label = group.querySelector('label');
            input.addEventListener('focus', () => label.classList.add('focused'));
            input.addEventListener('blur', () => {
                if (input.value === '') label.classList.remove('focused');
            });
        });
    }
    
    _setupParticles() {
        const container = document.querySelector('.particles-bg');
        if (!container) return;
        const particleCount = 20;
        for (let i = 0; i < particleCount; i++) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            const size = Math.random() * 3 + 1;
            particle.style.width = `${size}px`;
            particle.style.height = `${size}px`;
            particle.style.left = `${Math.random() * 100}%`;
            particle.style.animationDelay = `${Math.random() * 10}s`;
            particle.style.animationDuration = `${Math.random() * 10 + 10}s`;
            container.appendChild(particle);
        }
    }
}

document.addEventListener('DOMContentLoaded', () => {
    new PortfolioApp();
});